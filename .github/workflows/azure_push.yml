name: Build and Push Kubernetes App to Azure

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_CONTAINER_REGISTRY: "filmdatahubregistry"
  AZURE_RESOURCE_GROUP: "FilmDataHubRG"
  AZURE_CLUSTER_NAME: "filmdatahub-cluster"
  DOCKER_IMAGE_TAG: ${{ github.sha }}
  DATABASE_NAME: "filmdatahub-db"
  DATABASE_USERNAME: "user123"
  DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
  DATABASE_HOST: "filmdatahub-dbserver.mysql.database.azure.com"
  DATABASE_PORT: "3306"

jobs:
  buildInfrastructure:
    name: Build Infrastructure
    permissions:
      actions: read
      contents: read
      id-token: write
    runs-on: ubuntu-latest
    steps:
      # Checks out the repository this file is in
      - uses: actions/checkout@v4
      # Logs in with your Azure credentials
      - name: Azure login
        run: make login
      # Install the Terraform CLI
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 1.13.1
      # Initialize Terraform
      - name: Initialize Terraform
        run: terraform -chdir=azure init
      # Validate Terraform
      - name: Validate Terraform
        run: terraform -chdir=azure validate
      # Plan Terraform
      - name: Plan Terraform
        run: terraform -chdir=azure plan -out=tfplan
      # Apply Terraform
      - name: Apply Terraform
        run: terraform -chdir=azure apply tfplan
  deployToAzure:
    permissions:
      actions: read
      contents: read
      id-token: write
    runs-on: ubuntu-latest
    needs: [buildInfrastructure]
    steps:
      # Checks out the repository and set everything up
      - uses: actions/checkout@v4
      # Set up QEMU
      - uses: docker/setup-qemu-action@v2
      # Set up Buildx
      - uses: docker/setup-buildx-action@v2
      # Run the deployment
      - name: Run Deployment
        run: make deploy-all
  